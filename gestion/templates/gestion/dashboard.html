{% load static %}
{% load humanize %}
{% load custom_tags %}
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tableau de bord | e-Cotisation</title>
    <link rel="stylesheet" href="{% static 'gestion/assets/css/styles.css' %}" />
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23ff0000' d='M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z'/%3E%3C/svg%3E" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Styles pour le menu latéral */
      .sidebar {
        width: 280px;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
        color: white;
        overflow-y: auto;
        transition: transform 0.3s ease;
        z-index: 1000;
      }
      
      .sidebar.collapsed {
        transform: translateX(-280px);
      }
      
      .main-content {
        margin-left: 280px;
        transition: margin-left 0.3s ease;
      }
      
      .main-content.expanded {
        margin-left: 0;
      }
      
      .sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .sidebar-menu {
        padding: 1rem 0;
      }
      
      .menu-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1.5rem;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
      }
      
      .menu-item:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border-left-color: #60a5fa;
      }
      
      .menu-item.active {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        border-left-color: #3b82f6;
      }
      
      .menu-item svg {
        width: 1.25rem;
        height: 1.25rem;
        margin-right: 0.75rem;
        flex-shrink: 0;
      }
      
      .menu-section {
        margin: 1rem 0;
        padding: 0 1.5rem;
      }
      
      .menu-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 0.5rem;
      }
      
      .topbar {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      .toggle-sidebar {
        background: none;
        border: none;
        color: #374151;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 0.375rem;
        transition: background-color 0.2s ease;
      }
      
      .toggle-sidebar:hover {
        background: #f3f4f6;
      }
      
      .content-area {
        padding: 2rem;
        min-height: calc(100vh - 80px);
      }
      
      .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Responsive */
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-280px);
        }
        
        .sidebar.mobile-open {
          transform: translateX(0);
        }
        
        .main-content {
          margin-left: 0;
        }
        
        .content-area {
          padding: 1rem;
        }
      }
      
      /* Styles existants conservés */
      .transition-opacity {
        transition-property: opacity;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      }
      .duration-300 {
        transition-duration: 300ms;
      }
      .card-hover {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }
      @media (max-width: 400px) {
        .stat-card {
          padding: 1rem !important;
        }
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }
      .btn-gradient {
        background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      }
      .btn-gradient:hover {
        background: linear-gradient(90deg, #2563eb, #7c3aed);
      }
      /* Style pour le bouton Back to Top */
        #back-to-top {
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
        }

        #back-to-top.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #back-to-top:hover {
            transform: translateY(-3px);
        }
        html{
          scroll-behavior: smooth;
        }
        .custom-gradient {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
        }
        
        /* Animations pour les cartes de statistiques */
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card.opacity-75 {
            opacity: 0.75;
        }
        
        .stat-card.scale-95 {
            transform: scale(0.95);
        }
        
        /* Animation de rotation pour l'icône de rafraîchissement */
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* Styles pour les notifications toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: none;
        }
        
        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            padding: 16px 20px;
            margin-bottom: 10px;
            min-width: 300px;
            max-width: 400px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            pointer-events: auto;
            border-left: 4px solid #10b981;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            border-left-color: #10b981;
        }
        
        .toast.warning {
            border-left-color: #f59e0b;
        }
        
        .toast.error {
            border-left-color: #ef4444;
        }
        
        .toast.info {
            border-left-color: #3b82f6;
        }
        
        .toast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .toast-title {
            font-weight: 600;
            font-size: 14px;
            color: #1f2937;
        }
        
        .toast-close {
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            font-size: 18px;
            padding: 0;
            line-height: 1;
        }
        
        .toast-message {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.4;
        }
        
        /* Styles pour le graphique des top contributeurs */
        @media (max-width: 768px) {
            #topContributeursChart {
                height: 300px !important;
            }
        }
        
        @media (max-width: 480px) {
            #topContributeursChart {
                height: 250px !important;
            }
        }
  </style>
  </head>
  <body class="bg-gray-50">
    <!-- Menu latéral -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="flex items-center">
          <svg class="w-8 h-8 text-blue-300 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
          </svg>
          <div>
            <h1 class="text-lg font-bold text-white">e-Cotisation</h1>
            <p class="text-xs text-blue-200">Tableau de bord</p>
          </div>
        </div>
      </div>
      
      <nav class="sidebar-menu">
        <div class="menu-section">
          <div class="menu-section-title">Vue d'ensemble</div>
          <a href="#" class="menu-item active" data-page="overview">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v6H8V5z"></path>
            </svg>
            Vue d'ensemble
          </a>
        </div>
        
        <div class="menu-section">
          <div class="menu-section-title">Campagnes</div>
          <a href="#" class="menu-item" data-page="campaign">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            Campagne en cours
          </a>
          <a href="#" class="menu-item" data-page="history">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Historique des paiements
          </a>
        </div>
        
        {% if user|is_tresorier %}
        <div class="menu-section">
          <div class="menu-section-title">Gestion</div>
          <a href="#" class="menu-item" data-page="validation">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Valider les paiements
          </a>
          <a href="#" class="menu-item" data-page="my-validations">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            Mes validations
          </a>
        </div>
        {% endif %}
        
        <div class="menu-section">
          <div class="menu-section-title">Compte</div>
          <a href="{% url 'modifier_profil' %}" class="menu-item">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            Modifier mon profil
          </a>
          <a href="{% url 'effectuer_paiement' %}" class="menu-item">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
            </svg>
            Faire un don
          </a>
        </div>
      </nav>
    </aside>

    <!-- Contenu principal -->
    <div class="main-content" id="main-content">
      <!-- Barre supérieure -->
      <header class="topbar">
        <div class="flex items-center">
          <button class="toggle-sidebar mr-4" id="toggle-sidebar">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
          <div>
            <h1 class="text-xl font-semibold text-gray-900">Bonjour, {{ user.membre.nom }} {{ user.membre.prenom }}</h1>
            <p class="text-sm text-gray-600">Votre impact solidaire en temps réel</p>
          </div>
        </div>
        
        <div class="flex items-center space-x-4">
          <a href="{% url 'accueil' %}" class="text-gray-600 hover:text-gray-900">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
            </svg>
          </a>
          <form method="post" action="{% url 'logout' %}" class="inline">
            {% csrf_token %}
            <button type="submit" class="text-gray-600 hover:text-red-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
              </svg>
            </button>
          </form>
        </div>
      </header>

      <!-- Zone de contenu -->
      <main class="content-area" id="content-area">
        <!-- Le contenu sera chargé ici via AJAX -->
      </main>
    </div>

    <!-- Conteneur pour les notifications toast -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- Indicateur de chargement -->
    <div id="loading-indicator" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50 hidden">
      <div class="bg-white p-6 rounded-lg shadow-lg flex items-center">
        <svg class="animate-spin h-8 w-8 text-primary mr-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Chargement en cours...</span>
      </div>
    </div>

    <!-- Bouton Back to Top -->
    <button id="back-to-top" class="fixed bottom-8 right-8 p-3 bg-primary text-white rounded-full shadow-lg hover:bg-primary/90 transition-all opacity-0 invisible">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up">
        <path d="m5 12 7-7 7 7"/>
        <path d="M12 19V5"/>
      </svg>
    </button>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Variables globales
        let currentPage = 'overview';
        let evolutionChart = null;
        let moyensPaiementChart = null;
        let topContributeursChart = null;
        const loadingIndicator = document.getElementById('loading-indicator');
        const contentArea = document.getElementById('content-area');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar');

        // Gestion du menu latéral
        function toggleSidebar() {
          sidebar.classList.toggle('collapsed');
          mainContent.classList.toggle('expanded');
        }

        if (toggleSidebarBtn) {
          toggleSidebarBtn.addEventListener('click', toggleSidebar);
        }

        // Gestion de la navigation
        function setActiveMenuItem(page) {
          document.querySelectorAll('.menu-item').forEach(item => {
            item.classList.remove('active');
          });
          document.querySelector(`[data-page="${page}"]`).classList.add('active');
        }

        // Fonction pour charger une page
        async function loadPage(page) {
          try {
            currentPage = page;
            setActiveMenuItem(page);
            
            // Afficher l'indicateur de chargement
            loadingIndicator.classList.remove('hidden');
            
            let url = '';
            let title = '';
            
            switch(page) {
              case 'overview':
                url = "{% url 'dashboard_overview' %}";
                title = 'Vue d\'ensemble';
                break;
              case 'campaign':
                url = "{% url 'campagne_courante' %}?ajax=1";
                title = 'Campagne en cours';
                break;
              case 'history':
                url = "{% url 'historique_paiements' %}?ajax=1";
                title = 'Historique des paiements';
                break;
              case 'validation':
                url = "{% url 'paiements_a_valider' %}?ajax=1";
                title = 'Valider les paiements';
                break;
              case 'my-validations':
                url = "{% url 'paiements_valides_par_moi' %}?ajax=1";
                title = 'Mes validations';
                break;
              default:
                url = "{% url 'dashboard_overview' %}";
                title = 'Vue d\'ensemble';
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error('Erreur de chargement');

            const contentType = response.headers.get('content-type');
            let html = '';

            if (contentType && contentType.includes('application/json')) {
              const data = await response.json();
              html = data.html;
            } else {
              html = await response.text();
            }

            contentArea.innerHTML = html;
            
            // Initialiser les composants spécifiques à la page
            if (page === 'overview') {
              initializeOverviewPage();
            } else if (page === 'history') {
              initializeFilters();
            } else if (page === 'validation') {
              initializeFilters();
            }

          } catch (error) {
            console.error('Erreur lors du chargement:', error);
            contentArea.innerHTML = `
              <div class="p-4 bg-red-50 border-l-4 border-red-500 text-red-700">
                <p>Erreur lors du chargement : ${error.message}</p>
              </div>
            `;
          } finally {
            loadingIndicator.classList.add('hidden');
          }
        }

        // Fonction pour initialiser les filtres
        function initializeFilters() {
          console.log('Initialisation des filtres...');
          
          // Attendre un peu que le DOM soit mis à jour
          setTimeout(() => {
            // Initialiser les filtres pour l'historique des paiements
            if (document.getElementById('search-paiements')) {
              initHistoriqueFilters();
            }
            
            // Initialiser les filtres pour les paiements à valider
            if (document.getElementById('search-paiements-valider')) {
              initValidationFilters();
            }
          }, 100);
        }

        // Fonction pour initialiser les filtres de l'historique
        function initHistoriqueFilters() {
          console.log('Initialisation des filtres historique...');
          
          const searchInput = document.getElementById('search-paiements');
          const filterPeriode = document.getElementById('filter-periode');
          const sortPaiements = document.getElementById('sort-paiements');
          const resetFilters = document.getElementById('reset-filters');
          const searchResults = document.getElementById('search-results');
          const resultsCount = document.getElementById('results-count');
          const searchLoading = document.getElementById('search-loading');
          const paiementsContainer = document.getElementById('paiements-container');
          const paiementItems = document.querySelectorAll('.paiement-item');
          
          if (!searchInput || !filterPeriode || !sortPaiements || !resetFilters) {
            console.log('Éléments de filtrage historique non trouvés');
            return;
          }
          
          let allPaiements = Array.from(paiementItems);
          let filteredPaiements = [...allPaiements];
          let filterTimeout;
          
          console.log('Filtres historique initialisés avec', allPaiements.length, 'paiements');
          
          // Fonction de filtrage avec debounce pour la recherche
          function filterPaiements(immediate = false) {
            if (!immediate) {
              clearTimeout(filterTimeout);
              filterTimeout = setTimeout(() => filterPaiements(true), 300);
              return;
            }
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            const periodeFilter = filterPeriode.value;
            const sortBy = sortPaiements.value;
            
            // Afficher l'indicateur de chargement
            if (searchLoading) {
              searchLoading.classList.remove('hidden');
            }
            
            // Simuler un délai pour l'effet visuel
            setTimeout(() => {
              console.log('Filtrage historique avec:', { searchTerm, periodeFilter, sortBy });
              
              // Filtrer par recherche
              filteredPaiements = allPaiements.filter(item => {
                const montant = item.dataset.montant;
                const cotisation = item.dataset.cotisation;
                const moyen = item.dataset.moyen;
                
                const matchesSearch = !searchTerm || 
                  montant.includes(searchTerm) || 
                  cotisation.includes(searchTerm) || 
                  moyen.includes(searchTerm);
                
                // Filtrer par période
                let matchesPeriode = true;
                if (periodeFilter) {
                  const itemDate = new Date(item.dataset.date);
                  const now = new Date();
                  const daysDiff = Math.floor((now - itemDate) / (1000 * 60 * 60 * 24));
                  matchesPeriode = daysDiff <= parseInt(periodeFilter);
                }
                
                return matchesSearch && matchesPeriode;
              });
              
              // Trier les résultats
              if (sortBy) {
                filteredPaiements.sort((a, b) => {
                  if (sortBy.includes('montant')) {
                    const aMontant = parseFloat(a.dataset.montant);
                    const bMontant = parseFloat(b.dataset.montant);
                    return sortBy === 'montant' ? aMontant - bMontant : bMontant - aMontant;
                  } else if (sortBy.includes('date_paiement')) {
                    const aDate = new Date(a.dataset.date);
                    const bDate = new Date(b.dataset.date);
                    return sortBy === 'date_paiement' ? aDate - bDate : bDate - aDate;
                  }
                  return 0;
                });
              }
              
              console.log('Résultats filtrés historique:', filteredPaiements.length);
              
              // Afficher les résultats
              displayResults();
              
              // Masquer l'indicateur de chargement
              if (searchLoading) {
                searchLoading.classList.add('hidden');
              }
            }, 150);
          }
          
          // Fonction d'affichage des résultats avec animation
          function displayResults() {
            // Masquer tous les éléments avec animation
            allPaiements.forEach((item, index) => {
              item.style.opacity = '0';
              item.style.transform = 'translateY(10px)';
              item.style.transition = 'all 0.3s ease';
              
              setTimeout(() => {
                item.style.display = 'none';
              }, 300);
            });
            
            // Afficher les éléments filtrés avec animation
            setTimeout(() => {
              filteredPaiements.forEach((item, index) => {
                item.style.display = 'block';
                
                setTimeout(() => {
                  item.style.opacity = '1';
                  item.style.transform = 'translateY(0)';
                }, index * 50);
              });
              
              // Mettre à jour le compteur
              if (resultsCount) {
                resultsCount.textContent = filteredPaiements.length;
              }
              
              // Afficher/masquer la section résultats
              if (searchResults) {
                if (searchInput.value || filterPeriode.value) {
                  searchResults.classList.remove('hidden');
                } else {
                  searchResults.classList.add('hidden');
                }
              }
              
              // Afficher un message si aucun résultat
              showNoResultsMessage();
            }, 350);
          }
          
          // Fonction pour afficher le message "aucun résultat"
          function showNoResultsMessage() {
            const existingNoResults = paiementsContainer.querySelector('.no-results-message');
            if (existingNoResults) {
              existingNoResults.remove();
            }
            
            if (filteredPaiements.length === 0 && (searchInput.value || filterPeriode.value)) {
              const noResultsDiv = document.createElement('div');
              noResultsDiv.className = 'no-results-message p-12 text-center';
              noResultsDiv.innerHTML = `
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Aucun résultat trouvé</h3>
                <p class="mt-1 text-sm text-gray-500">Essayez de modifier vos critères de recherche.</p>
                <button onclick="resetAllFiltersHistorique()" class="mt-4 inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  Réinitialiser les filtres
                </button>
              `;
              
              paiementsContainer.appendChild(noResultsDiv);
            }
          }
          
          // Fonction de réinitialisation globale
          window.resetAllFiltersHistorique = function() {
            searchInput.value = '';
            filterPeriode.value = '';
            sortPaiements.value = '-date_paiement';
            filteredPaiements = [...allPaiements];
            displayResults();
          };
          
          // Événements avec feedback visuel
          searchInput.addEventListener('input', () => {
            filterPaiements(false); // Avec debounce
          });
          
          filterPeriode.addEventListener('change', () => {
            filterPaiements(true); // Immédiat
          });
          
          sortPaiements.addEventListener('change', () => {
            filterPaiements(true); // Immédiat
          });
          
          resetFilters.addEventListener('click', resetAllFiltersHistorique);
          
          // Initialisation
          filterPaiements(true);
        }

        // Fonction pour initialiser les filtres de validation
        function initValidationFilters() {
          console.log('Initialisation des filtres validation...');
          
          const searchInput = document.getElementById('search-paiements-valider');
          const filterPeriode = document.getElementById('filter-periode-valider');
          const sortPaiements = document.getElementById('sort-paiements-valider');
          const resetFilters = document.getElementById('reset-filters-valider');
          const searchResults = document.getElementById('search-results-valider');
          const resultsCount = document.getElementById('results-count-valider');
          const searchLoading = document.getElementById('search-loading-valider');
          const paiementsContainer = document.getElementById('paiements-container-valider');
          const paiementItems = document.querySelectorAll('.paiement-item-valider');
          
          if (!searchInput || !filterPeriode || !sortPaiements || !resetFilters) {
            console.log('Éléments de filtrage validation non trouvés');
            return;
          }
          
          let allPaiements = Array.from(paiementItems);
          let filteredPaiements = [...allPaiements];
          let filterTimeout;
          
          console.log('Filtres validation initialisés avec', allPaiements.length, 'paiements');
          
          // Fonction de filtrage avec debounce pour la recherche
          function filterPaiements(immediate = false) {
            if (!immediate) {
              clearTimeout(filterTimeout);
              filterTimeout = setTimeout(() => filterPaiements(true), 300);
              return;
            }
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            const periodeFilter = filterPeriode.value;
            const sortBy = sortPaiements.value;
            
            // Afficher l'indicateur de chargement
            if (searchLoading) {
              searchLoading.classList.remove('hidden');
            }
            
            // Simuler un délai pour l'effet visuel
            setTimeout(() => {
              console.log('Filtrage validation avec:', { searchTerm, periodeFilter, sortBy });
              
              // Filtrer par recherche
              filteredPaiements = allPaiements.filter(item => {
                const montant = item.dataset.montant;
                const cotisation = item.dataset.cotisation;
                const membre = item.dataset.membre;
                
                const matchesSearch = !searchTerm || 
                  montant.includes(searchTerm) || 
                  cotisation.includes(searchTerm) || 
                  membre.includes(searchTerm);
                
                // Filtrer par période
                let matchesPeriode = true;
                if (periodeFilter) {
                  const itemDate = new Date(item.dataset.date);
                  const now = new Date();
                  const daysDiff = Math.floor((now - itemDate) / (1000 * 60 * 60 * 24));
                  matchesPeriode = daysDiff <= parseInt(periodeFilter);
                }
                
                return matchesSearch && matchesPeriode;
              });
              
              // Trier les résultats
              if (sortBy) {
                filteredPaiements.sort((a, b) => {
                  if (sortBy.includes('montant')) {
                    const aMontant = parseFloat(a.dataset.montant);
                    const bMontant = parseFloat(b.dataset.montant);
                    return sortBy === 'montant' ? aMontant - bMontant : bMontant - aMontant;
                  } else if (sortBy.includes('date_paiement')) {
                    const aDate = new Date(a.dataset.date);
                    const bDate = new Date(b.dataset.date);
                    return sortBy === 'date_paiement' ? aDate - bDate : bDate - aDate;
                  } else if (sortBy.includes('membre__nom')) {
                    const aMembre = a.dataset.membre;
                    const bMembre = b.dataset.membre;
                    return sortBy === 'membre__nom' ? aMembre.localeCompare(bMembre) : bMembre.localeCompare(aMembre);
                  }
                  return 0;
                });
              }
              
              console.log('Résultats filtrés validation:', filteredPaiements.length);
              
              // Afficher les résultats
              displayResults();
              
              // Masquer l'indicateur de chargement
              if (searchLoading) {
                searchLoading.classList.add('hidden');
              }
            }, 150);
          }
          
          // Fonction d'affichage des résultats avec animation
          function displayResults() {
            // Masquer tous les éléments avec animation
            allPaiements.forEach((item, index) => {
              item.style.opacity = '0';
              item.style.transform = 'translateY(10px)';
              item.style.transition = 'all 0.3s ease';
              
              setTimeout(() => {
                item.style.display = 'none';
              }, 300);
            });
            
            // Afficher les éléments filtrés avec animation
            setTimeout(() => {
              filteredPaiements.forEach((item, index) => {
                item.style.display = 'block';
                
                setTimeout(() => {
                  item.style.opacity = '1';
                  item.style.transform = 'translateY(0)';
                }, index * 50);
              });
              
              // Mettre à jour le compteur
              if (resultsCount) {
                resultsCount.textContent = filteredPaiements.length;
              }
              
              // Afficher/masquer la section résultats
              if (searchResults) {
                if (searchInput.value || filterPeriode.value) {
                  searchResults.classList.remove('hidden');
                } else {
                  searchResults.classList.add('hidden');
                }
              }
              
              // Afficher un message si aucun résultat
              showNoResultsMessage();
            }, 350);
          }
          
          // Fonction pour afficher le message "aucun résultat"
          function showNoResultsMessage() {
            const existingNoResults = paiementsContainer.querySelector('.no-results-message');
            if (existingNoResults) {
              existingNoResults.remove();
            }
            
            if (filteredPaiements.length === 0 && (searchInput.value || filterPeriode.value)) {
              const noResultsDiv = document.createElement('div');
              noResultsDiv.className = 'no-results-message p-12 text-center';
              noResultsDiv.innerHTML = `
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Aucun paiement trouvé</h3>
                <p class="mt-1 text-sm text-gray-500">Aucun paiement ne correspond à vos critères de recherche.</p>
                <button onclick="resetAllFiltersValidation()" class="mt-4 inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  Réinitialiser les filtres
                </button>
              `;
              
              paiementsContainer.appendChild(noResultsDiv);
            }
          }
          
          // Fonction de réinitialisation globale
          window.resetAllFiltersValidation = function() {
            searchInput.value = '';
            filterPeriode.value = '';
            sortPaiements.value = '-date_paiement';
            filteredPaiements = [...allPaiements];
            displayResults();
          };
          
          // Événements avec feedback visuel
          searchInput.addEventListener('input', () => {
            filterPaiements(false); // Avec debounce
          });
          
          filterPeriode.addEventListener('change', () => {
            filterPaiements(true); // Immédiat
          });
          
          sortPaiements.addEventListener('change', () => {
            filterPaiements(true); // Immédiat
          });
          
          resetFilters.addEventListener('click', resetAllFiltersValidation);
          
          // Initialisation
          filterPaiements(true);
        }

        // Initialisation de la page vue d'ensemble
        function initializeOverviewPage() {
          loadChartsData();
          updateStats();
          
          // Mise à jour automatique
          setInterval(updateStats, 30000);
          setInterval(loadChartsData, 120000);
        }

        // Gestionnaires d'événements pour les éléments de menu
        document.querySelectorAll('.menu-item[data-page]').forEach(item => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            const page = item.dataset.page;
            loadPage(page);
          });
        });

        // Fonction pour créer le graphique d'évolution
        function createEvolutionChart(data) {
          const ctx = document.getElementById('evolutionChart');
          if (!ctx) return;

          if (evolutionChart) {
            evolutionChart.destroy();
          }

          evolutionChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.labels,
              datasets: [{
                label: 'Montant collecté (FCFA)',
                data: data.data,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#3b82f6',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return value.toLocaleString() + ' FCFA';
                    }
                  }
                }
              },
              interaction: {
                intersect: false,
                mode: 'index'
              }
            }
          });
        }

        // Fonction pour créer le graphique des moyens de paiement
        function createMoyensPaiementChart(data) {
          const ctx = document.getElementById('moyensPaiementChart');
          if (!ctx) return;

          if (moyensPaiementChart) {
            moyensPaiementChart.destroy();
          }

          const colors = [
            '#3b82f6', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b',
            '#ef4444', '#84cc16', '#f97316', '#ec4899', '#6366f1'
          ];

          moyensPaiementChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: data.labels,
              datasets: [{
                data: data.data,
                backgroundColor: colors.slice(0, data.labels.length),
                borderWidth: 2,
                borderColor: '#ffffff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    padding: 20,
                    usePointStyle: true
                  }
                }
              }
            }
          });
        }

        // Fonction pour créer le graphique des top contributeurs
        function createTopContributeursChart(data) {
          const ctx = document.getElementById('topContributeursChart');
          if (!ctx) return;

          if (topContributeursChart) {
            topContributeursChart.destroy();
          }

          topContributeursChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.labels,
              datasets: [{
                label: 'Montant contribué (FCFA)',
                data: data.data,
                backgroundColor: [
                  '#fbbf24', '#f59e0b', '#d97706', '#92400e', '#78350f'
                ],
                borderColor: '#ffffff',
                borderWidth: 2,
                borderRadius: 8
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  callbacks: {
                    title: function(context) {
                      if (data.original_names && data.original_names[context[0].dataIndex]) {
                        return data.original_names[context[0].dataIndex];
                      }
                      return context[0].label;
                    }
                  }
                }
              },
              scales: {
                x: {
                  ticks: {
                    maxRotation: 45,
                    minRotation: 0,
                    font: {
                      size: 11
                    }
                  }
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return value.toLocaleString() + ' FCFA';
                    },
                    font: {
                      size: 11
                    }
                  }
                }
              },
              layout: {
                padding: {
                  left: 10,
                  right: 10,
                  top: 10,
                  bottom: 10
                }
              }
            }
          });
        }

        // Fonction pour charger les données des graphiques
        async function loadChartsData() {
          try {
            const response = await fetch("{% url 'dashboard_charts_data' %}", {
              headers: {
                'X-Requested-With': 'XMLHttpRequest'
              }
            });
            
            if (!response.ok) throw new Error('Erreur lors de la récupération des données graphiques');
            
            const data = await response.json();
            
            if (data.has_data) {
              createEvolutionChart(data.evolution);
              createMoyensPaiementChart(data.moyens_paiement);
              
              if (data.top_contributeurs && data.is_tresorier) {
                createTopContributeursChart(data.top_contributeurs);
              }
            } else {
              showNoDataMessage('evolutionChart', data.is_tresorier ? 
                'Aucune contribution enregistrée ces 7 derniers jours' : 
                'Vous n\'avez pas encore fait de contribution');
              
              showNoDataMessage('moyensPaiementChart', data.is_tresorier ? 
                'Aucun moyen de paiement utilisé' : 
                'Vous n\'avez pas encore utilisé de moyen de paiement');
              
              if (data.is_tresorier) {
                showNoDataMessage('topContributeursChart', 'Aucun contributeur enregistré');
              }
            }

          } catch (error) {
            console.error('Erreur lors du chargement des graphiques:', error);
          }
        }

        // Fonction pour afficher un message quand il n'y a pas de données
        function showNoDataMessage(canvasId, message) {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return;

          const parent = canvas.parentElement;
          
          const messageDiv = document.createElement('div');
          messageDiv.className = 'flex items-center justify-center h-48 text-gray-500 text-center';
          messageDiv.innerHTML = `
            <div>
              <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
              <p class="text-sm">${message}</p>
            </div>
          `;
          
          parent.innerHTML = '';
          parent.appendChild(messageDiv);
        }

        // Fonction pour mettre à jour les statistiques
        async function updateStats() {
          try {
            const response = await fetch("{% url 'dashboard_stats' %}", {
              headers: {
                'X-Requested-With': 'XMLHttpRequest'
              }
            });
            
            if (!response.ok) throw new Error('Erreur lors de la récupération des statistiques');
            
            const data = await response.json();
            
            // Mise à jour des cartes de statistiques
            updateStatCards(data);

          } catch (error) {
            console.error('Erreur lors de la mise à jour des statistiques:', error);
          }
        }

        // Fonction pour mettre à jour les cartes de statistiques
        function updateStatCards(data) {
          // Cette fonction sera appelée depuis la page vue d'ensemble
          // pour mettre à jour les cartes de statistiques
        }

        // Fonction pour afficher les notifications toast
        function showToast(title, message, type = 'success', duration = 5000) {
          const container = document.getElementById('toast-container');
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          
          toast.innerHTML = `
            <div class="toast-header">
              <div class="toast-title">${title}</div>
              <button class="toast-close" onclick="this.parentElement.parentElement.remove()">×</button>
            </div>
            <div class="toast-message">${message}</div>
          `;
          
          container.appendChild(toast);
          
          setTimeout(() => {
            toast.classList.add('show');
          }, 100);
          
          if (duration > 0) {
            setTimeout(() => {
              toast.classList.remove('show');
              setTimeout(() => {
                if (toast.parentElement) {
                  toast.remove();
                }
              }, 300);
            }, duration);
          }
        }

        // Gestion des formulaires de validation
        document.addEventListener('submit', function (e) {
          if (e.target.matches('.form-validation')) {
            e.preventDefault();

            const form = e.target;
            const url = form.action;

            fetch(url, {
              method: 'POST',
              headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
              },
              body: new FormData(form)
            })
            .then(response => {
              if (!response.ok) throw new Error('Erreur lors de la validation');
              const container = form.closest('.bg-white.border.rounded');
              container.innerHTML = `<p class="text-green-600 font-semibold">✅ Paiement validé</p>`;
              
              // Déclencher la mise à jour des statistiques
              document.dispatchEvent(new CustomEvent('paiementValide'));
            })
            .catch(err => {
              console.error(err);
              alert("Une erreur s'est produite. Réessaye.");
            });
          }
        });

        // Gestion du bouton "Valider tous les paiements"
        document.addEventListener('click', function (e) {
          if (e.target.id === 'valider-tous-btn') {
            e.preventDefault();
            if (!confirm("Confirmer la validation de tous les paiements ?")) return;

            fetch("{% url 'valider_tous_les_paiements' %}", {
              method: 'POST',
              headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
              }
            })
            .then(response => response.json())
            .then(data => {
              if (data.message) {
                showToast('Succès', data.message, 'success');
                // Recharger la page de validation
                setTimeout(() => loadPage('validation'), 1000);
              }
            })
            .catch(err => {
              console.error(err);
              showToast('Erreur', 'Une erreur est survenue', 'error');
            });
          }
        });

        // Fonction pour récupérer le cookie CSRF
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }

        // Bouton Back to Top
        const backToTopButton = document.getElementById('back-to-top');
        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
              backToTopButton.classList.add('visible');
              backToTopButton.classList.remove('opacity-0', 'invisible');
            } else {
              backToTopButton.classList.remove('visible');
              backToTopButton.classList.add('opacity-0', 'invisible');
            }
        });
        backToTopButton.addEventListener('click', () => {
           window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Charger la page vue d'ensemble par défaut
        loadPage('overview');
      });
    </script>
  </body>
</html>
