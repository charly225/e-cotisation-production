{% load static %}
{% load humanize %}
{% load custom_tags %}
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tableau de bord | e-Cotisation</title>
    <link rel="stylesheet" href="{% static 'gestion/assets/css/styles.css' %}" />
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23ff0000' d='M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z'/%3E%3C/svg%3E" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Styles pour le menu latéral */
      .sidebar {
        width: 280px;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
        color: white;
        overflow-y: auto;
        transition: transform 0.3s ease;
        z-index: 1000;
      }
      
      .sidebar.collapsed {
        transform: translateX(-280px);
      }
      
      .main-content {
        margin-left: 280px;
        transition: margin-left 0.3s ease;
      }
      
      .main-content.expanded {
        margin-left: 0;
      }
      
      .sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .sidebar-menu {
        padding: 1rem 0;
      }
      
      .menu-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1.5rem;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
      }
      
      .menu-item:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border-left-color: #60a5fa;
      }
      
      .menu-item.active {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        border-left-color: #3b82f6;
      }
      
      .menu-item svg {
        width: 1.25rem;
        height: 1.25rem;
        margin-right: 0.75rem;
        flex-shrink: 0;
      }
      
      .menu-section {
        margin: 1rem 0;
        padding: 0 1.5rem;
      }
      
      .menu-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 0.5rem;
      }
      
      .topbar {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      .toggle-sidebar {
        background: none;
        border: none;
        color: #374151;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 0.375rem;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .toggle-sidebar:hover {
        background: #f3f4f6;
      }
      
      .toggle-sidebar:active {
        background: #e5e7eb;
      }
      
      @media (max-width: 1024px) {
        .toggle-sidebar {
          background: #f3f4f6;
          border: 1px solid #d1d5db;
        }
        
        .toggle-sidebar:hover {
          background: #e5e7eb;
        }
      }
      
      .content-area {
        padding: 2rem;
        min-height: calc(100vh - 80px);
      }
      
      .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Responsive */
      @media (max-width: 1024px) {
        .sidebar {
          transform: translateX(-280px);
          box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar.mobile-open {
          transform: translateX(0);
          box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
        }
        
        .main-content {
          margin-left: 0;
        }
        
        .content-area {
          padding: 1.5rem;
        }
        
        /* Overlay sombre quand la sidebar est ouverte sur mobile */
        .sidebar.mobile-open::before {
          content: '';
          position: fixed;
          top: 0;
          left: 280px;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: -1;
        }
      }
      
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-280px);
          box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar.mobile-open {
          transform: translateX(0);
          box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
        }
        
        .main-content {
          margin-left: 0;
        }
        
        .content-area {
          padding: 1rem;
        }
        
        .topbar {
          padding: 1rem;
        }
        
        /* Overlay sombre quand la sidebar est ouverte sur mobile */
        .sidebar.mobile-open::before {
          content: '';
          position: fixed;
          top: 0;
          left: 280px;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: -1;
        }
      }
      
      @media (max-width: 640px) {
        .sidebar {
          width: 260px;
          transform: translateX(-260px);
          box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar.collapsed {
          transform: translateX(-260px);
        }
        
        .sidebar.mobile-open {
          transform: translateX(0);
          box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
        }
        
        .content-area {
          padding: 0.75rem;
        }
        
        /* Overlay sombre quand la sidebar est ouverte sur mobile */
        .sidebar.mobile-open::before {
          content: '';
          position: fixed;
          top: 0;
          left: 260px;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: -1;
        }
      }
      
      /* Styles pour les notifications toast */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        pointer-events: none;
      }
      
      .toast {
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        padding: 16px 20px;
        margin-bottom: 10px;
        min-width: 300px;
        max-width: 400px;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        pointer-events: auto;
        border-left: 4px solid #10b981;
      }
      
      .toast.show {
        transform: translateX(0);
      }
      
      .toast.success {
        border-left-color: #10b981;
      }
      
      .toast.warning {
        border-left-color: #f59e0b;
      }
      
      .toast.error {
        border-left-color: #ef4444;
      }
      
      .toast.info {
        border-left-color: #3b82f6;
      }
      
      .toast-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      
      .toast-title {
        font-weight: 600;
        font-size: 14px;
        color: #1f2937;
      }
      
      .toast-close {
        background: none;
        border: none;
        cursor: pointer;
        color: #6b7280;
        font-size: 18px;
        padding: 0;
        line-height: 1;
      }
      
      .toast-message {
        font-size: 13px;
        color: #6b7280;
        line-height: 1.4;
      }
      
      /* Styles pour les cartes de statistiques */
      .stat-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      
      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      
      .stat-card .text-2xl {
        font-size: 1.75rem;
        line-height: 1.2;
      }
      
      .stat-card .text-sm {
        font-size: 0.875rem;
        line-height: 1.4;
      }
      
      .stat-card .text-xs {
        font-size: 0.75rem;
        line-height: 1.3;
      }
      
      /* Responsive pour les cartes */
      @media (max-width: 640px) {
        .stat-card {
          padding: 1.25rem;
          min-height: 120px;
        }
        
        .stat-card .text-2xl {
          font-size: 1.5rem;
        }
      }
      
      /* Styles pour le thème sombre */
      .dark {
        color-scheme: dark;
      }
      
      .dark body {
        background-color: #111827;
        color: #f9fafb;
      }
      
      .dark .topbar {
        background: #1f2937;
        border-bottom-color: #374151;
      }
      
      .dark .content-area {
        background-color: #111827;
      }
      
      .dark .stat-card {
        background: #1f2937;
        border-color: #374151;
        color: #f9fafb;
      }
      
      .dark .stat-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      
      .dark .sidebar {
        background: linear-gradient(180deg, #1e1b4b 0%, #312e81 100%);
      }
      
      .dark .menu-item {
        color: rgba(255, 255, 255, 0.7);
      }
      
      .dark .menu-item:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }
      
      .dark .menu-item.active {
        background: rgba(255, 255, 255, 0.15);
        color: white;
      }
      
      .dark .menu-section-title {
        color: rgba(255, 255, 255, 0.4);
      }
      
      .dark .toggle-sidebar {
        color: #d1d5db;
      }
      
      .dark .toggle-sidebar:hover {
        background: #374151;
      }
      
      .dark .toast {
        background: #1f2937;
        color: #f9fafb;
        border-color: #374151;
      }
      
      .dark .toast-title {
        color: #f9fafb;
      }
      
      .dark .toast-message {
        color: #d1d5db;
      }
      
      .dark .toast-close {
        color: #9ca3af;
      }
      
      .dark .toast-close:hover {
        color: #d1d5db;
      }
      
      /* Styles pour la barre de progression */
      .progress-container {
        width: 100%;
        background-color: #e5e7eb;
        border-radius: 8px;
        height: 16px;
        border: 1px solid #d1d5db;
        overflow: hidden;
      }
      
      .progress-fill {
        height: 100%;
        background-color: #3b82f6;
        border-radius: 8px;
        transition: width 0.5s ease;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Menu latéral -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="flex items-center">
          <svg class="w-8 h-8 text-blue-300 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
          </svg>
          <div>
            <h1 class="text-lg font-bold text-white">e-Cotisation</h1>
            <p class="text-xs text-blue-200">Tableau de bord</p>
          </div>
        </div>
      </div>
      
      <nav class="sidebar-menu">
        <div class="menu-section">
          <div class="menu-section-title">Vue d'ensemble</div>
          <a href="#" class="menu-item active" data-page="overview">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v6H8V5z"></path>
            </svg>
            Vue d'ensemble
          </a>
        </div>
        
        <div class="menu-section">
          <div class="menu-section-title">Campagnes</div>
          <a href="#" class="menu-item" data-page="campaign">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            Campagne en cours
          </a>
          <a href="#" class="menu-item" data-page="history">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Historique des paiements
          </a>
        </div>
        
        {% if user|is_tresorier %}
        <div class="menu-section">
          <div class="menu-section-title">Gestion</div>
          <a href="#" class="menu-item" data-page="validation">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Valider les paiements
          </a>
          <a href="#" class="menu-item" data-page="my-validations">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            Mes validations
          </a>
        </div>
        {% endif %}
        
        <div class="menu-section">
          <div class="menu-section-title">Compte</div>
          <a href="{% url 'modifier_profil' %}" class="menu-item">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            Modifier mon profil
          </a>
          <a href="{% url 'effectuer_paiement' %}" class="menu-item">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
            </svg>
            Faire un don
          </a>
        </div>
      </nav>
    </aside>

    <!-- Contenu principal -->
    <div class="main-content" id="main-content">
      <!-- Barre supérieure -->
      <header class="topbar">
        <div class="flex items-center">
          <button class="toggle-sidebar mr-4" id="toggle-sidebar">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
          <div>
            <h1 class="text-xl font-semibold text-gray-900">Bonjour, {{ user.membre.nom }} {{ user.membre.prenom }}</h1>
            <p class="text-sm text-gray-600">Votre impact solidaire en temps réel</p>
          </div>
        </div>
        
        <div class="flex items-center space-x-4">
          <!-- Bouton de thème -->
          <button id="theme-toggle" class="text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white transition-colors">
            <svg id="theme-icon-light" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
            <svg id="theme-icon-dark" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
            </svg>
          </button>
          
          <a href="{% url 'accueil' %}" class="text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
            </svg>
          </a>
          <form method="post" action="{% url 'logout' %}" class="inline">
            {% csrf_token %}
            <button type="submit" class="text-gray-600 hover:text-red-600 dark:text-gray-300 dark:hover:text-red-400">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
              </svg>
            </button>
          </form>
        </div>
      </header>

      <!-- Zone de contenu -->
      <main class="content-area" id="content-area">
        <!-- Le contenu sera chargé ici via AJAX -->
      </main>
    </div>

    <!-- Conteneur pour les notifications toast -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- Indicateur de chargement -->
    <div id="loading-indicator" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50 hidden">
      <div class="bg-white p-6 rounded-lg shadow-lg flex items-center">
        <svg class="animate-spin h-8 w-8 text-blue-600 mr-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Chargement en cours...</span>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Variables globales
        let currentPage = 'overview';
        let evolutionChart = null;
        let moyensPaiementChart = null;
        let topContributeursChart = null;
        const loadingIndicator = document.getElementById('loading-indicator');
        const contentArea = document.getElementById('content-area');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar');

        // Gestion du menu latéral
        function toggleSidebar() {
          if (window.innerWidth <= 1024) {
            // Sur mobile/tablet, utiliser mobile-open pour l'overlay
            sidebar.classList.toggle('mobile-open');
          } else {
            // Sur desktop, utiliser collapsed/expanded
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
          }
        }

        if (toggleSidebarBtn) {
          toggleSidebarBtn.addEventListener('click', toggleSidebar);
        }

        // Fermer la sidebar en cliquant en dehors sur mobile
        document.addEventListener('click', function(e) {
          if (window.innerWidth <= 1024) {
            const isClickInsideSidebar = sidebar.contains(e.target);
            const isClickOnToggleButton = toggleSidebarBtn.contains(e.target);
            
            if (!isClickInsideSidebar && !isClickOnToggleButton && sidebar.classList.contains('mobile-open')) {
              sidebar.classList.remove('mobile-open');
            }
          }
        });

        // Gérer le redimensionnement de la fenêtre
        window.addEventListener('resize', function() {
          if (window.innerWidth > 1024) {
            // Sur desktop, toujours afficher la sidebar
            sidebar.classList.remove('collapsed', 'mobile-open');
            mainContent.classList.remove('expanded');
          } else {
            // Sur mobile/tablet, cacher la sidebar par défaut
            sidebar.classList.add('collapsed');
            sidebar.classList.remove('mobile-open');
            mainContent.classList.add('expanded');
          }
        });

        // Initialiser l'état de la sidebar au chargement
        if (window.innerWidth <= 1024) {
          sidebar.classList.add('collapsed');
          mainContent.classList.add('expanded');
        }

        // Gestion de la navigation
        function setActiveMenuItem(page) {
          document.querySelectorAll('.menu-item').forEach(item => {
            item.classList.remove('active');
          });
          document.querySelector(`[data-page="${page}"]`).classList.add('active');
        }

        // Fonction pour charger une page
        async function loadPage(page) {
          try {
            currentPage = page;
            setActiveMenuItem(page);
            
            // Afficher l'indicateur de chargement
            loadingIndicator.classList.remove('hidden');
            
            let url = '';
            
            switch(page) {
              case 'overview':
                url = "{% url 'dashboard_overview' %}";
                break;
              case 'campaign':
                url = "{% url 'campagne_courante' %}?ajax=1";
                break;
              case 'history':
                url = "{% url 'historique_paiements' %}?ajax=1";
                break;
              case 'validation':
                url = "{% url 'paiements_a_valider' %}?ajax=1";
                break;
              case 'my-validations':
                url = "{% url 'paiements_valides_par_moi' %}?ajax=1";
                break;
              default:
                url = "{% url 'dashboard_overview' %}";
            }

            const response = await fetch(url, {
              headers: {
                'X-Requested-With': 'XMLHttpRequest'
              }
            });
            if (!response.ok) throw new Error('Erreur de chargement');

            const contentType = response.headers.get('content-type');
            let html = '';

            if (contentType && contentType.includes('application/json')) {
              const data = await response.json();
              html = data.html;
            } else {
              html = await response.text();
            }

            contentArea.innerHTML = html;
            
            // Initialiser les composants spécifiques à la page
            if (page === 'overview') {
              initializeOverviewPage();
            } else if (page === 'history') {
              initializeFilters();
            } else if (page === 'validation') {
              initializeFilters();
            } else if (page === 'campaign') {
              // Mettre à jour les couleurs de la barre de progression
              setTimeout(updateProgressBarColors, 100);
            }

          } catch (error) {
            console.error('Erreur lors du chargement:', error);
            contentArea.innerHTML = `
              <div class="p-4 bg-red-50 border-l-4 border-red-500 text-red-700">
                <p>Erreur lors du chargement : ${error.message}</p>
              </div>
            `;
          } finally {
            loadingIndicator.classList.add('hidden');
          }
        }

        // Initialisation de la page vue d'ensemble
        function initializeOverviewPage() {
          loadChartsData();
          updateStats();
          
          // Mise à jour automatique
          setInterval(updateStats, 30000);
          setInterval(loadChartsData, 120000);
        }

        // Gestionnaires d'événements pour les éléments de menu
        document.querySelectorAll('.menu-item[data-page]').forEach(item => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            const page = item.dataset.page;
            loadPage(page);
            
            // Fermer la sidebar sur mobile après avoir cliqué sur un élément
            if (window.innerWidth <= 1024) {
              sidebar.classList.remove('mobile-open');
            }
          });
        });

        // Fonction pour créer le graphique d'évolution
        function createEvolutionChart(data) {
          const ctx = document.getElementById('evolutionChart');
          if (!ctx) return;

          if (evolutionChart) {
            evolutionChart.destroy();
          }

          evolutionChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.labels,
              datasets: [{
                label: 'Montant collecté (FCFA)',
                data: data.data,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#3b82f6',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return value.toLocaleString() + ' FCFA';
                    }
                  }
                }
              },
              interaction: {
                intersect: false,
                mode: 'index'
              }
            }
          });
        }

        // Fonction pour créer le graphique des moyens de paiement
        function createMoyensPaiementChart(data) {
          const ctx = document.getElementById('moyensPaiementChart');
          if (!ctx) return;

          if (moyensPaiementChart) {
            moyensPaiementChart.destroy();
          }

          const colors = [
            '#3b82f6', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b',
            '#ef4444', '#84cc16', '#f97316', '#ec4899', '#6366f1'
          ];

          moyensPaiementChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: data.labels,
              datasets: [{
                data: data.data,
                backgroundColor: colors.slice(0, data.labels.length),
                borderWidth: 2,
                borderColor: '#ffffff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    padding: 20,
                    usePointStyle: true
                  }
                }
              }
            }
          });
        }

        // Fonction pour créer le graphique des top contributeurs
        function createTopContributeursChart(data) {
          const ctx = document.getElementById('topContributeursChart');
          if (!ctx) return;

          if (topContributeursChart) {
            topContributeursChart.destroy();
          }

          topContributeursChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.labels,
              datasets: [{
                label: 'Montant contribué (FCFA)',
                data: data.data,
                backgroundColor: [
                  '#fbbf24', '#f59e0b', '#d97706', '#92400e', '#78350f'
                ],
                borderColor: '#ffffff',
                borderWidth: 2,
                borderRadius: 8
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  callbacks: {
                    title: function(context) {
                      if (data.original_names && data.original_names[context[0].dataIndex]) {
                        return data.original_names[context[0].dataIndex];
                      }
                      return context[0].label;
                    }
                  }
                }
              },
              scales: {
                x: {
                  ticks: {
                    maxRotation: 45,
                    minRotation: 0,
                    font: {
                      size: 11
                    }
                  }
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return value.toLocaleString() + ' FCFA';
                    },
                    font: {
                      size: 11
                    }
                  }
                }
              },
              layout: {
                padding: {
                  left: 10,
                  right: 10,
                  top: 10,
                  bottom: 10
                }
              }
            }
          });
        }

        // Fonction pour charger les données des graphiques
        async function loadChartsData() {
          try {
            const response = await fetch("{% url 'dashboard_charts_data' %}", {
              headers: {
                'X-Requested-With': 'XMLHttpRequest'
              }
            });
            
            if (!response.ok) throw new Error('Erreur lors de la récupération des données graphiques');
            
            const data = await response.json();
            
            if (data.has_data) {
              createEvolutionChart(data.evolution);
              createMoyensPaiementChart(data.moyens_paiement);
              
              if (data.top_contributeurs && data.is_tresorier) {
                createTopContributeursChart(data.top_contributeurs);
              }
            } else {
              showNoDataMessage('evolutionChart', data.is_tresorier ? 
                'Aucune contribution enregistrée ces 7 derniers jours' : 
                'Vous n\'avez pas encore fait de contribution');
              
              showNoDataMessage('moyensPaiementChart', data.is_tresorier ? 
                'Aucun moyen de paiement utilisé' : 
                'Vous n\'avez pas encore utilisé de moyen de paiement');
              
              if (data.is_tresorier) {
                showNoDataMessage('topContributeursChart', 'Aucun contributeur enregistré');
              }
            }

          } catch (error) {
            console.error('Erreur lors du chargement des graphiques:', error);
          }
        }

        // Fonction pour afficher un message quand il n'y a pas de données
        function showNoDataMessage(canvasId, message) {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return;

          const parent = canvas.parentElement;
          
          const messageDiv = document.createElement('div');
          messageDiv.className = 'flex items-center justify-center h-48 text-gray-500 text-center';
          messageDiv.innerHTML = `
            <div>
              <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
              <p class="text-sm">${message}</p>
            </div>
          `;
          
          parent.innerHTML = '';
          parent.appendChild(messageDiv);
        }

        // Fonction pour mettre à jour les statistiques
        async function updateStats(skipToasts = false) {
          try {
            const response = await fetch("{% url 'dashboard_stats' %}", {
              headers: {
                'X-Requested-With': 'XMLHttpRequest'
              }
            });
            
            if (!response.ok) throw new Error('Erreur lors de la récupération des statistiques');
            
            const data = await response.json();
            
            // Mise à jour des cartes de statistiques
            updateStatCards(data);
            
            // Afficher les alertes d'objectifs seulement si pas d'actualisation manuelle
            if (!skipToasts) {
              checkAndShowAchievementAlerts(data);
            }

          } catch (error) {
            console.error('Erreur lors de la mise à jour des statistiques:', error);
          }
        }

        // Fonction pour mettre à jour les cartes de statistiques
        function updateStatCards(data) {
          // Cette fonction sera appelée depuis la page vue d'ensemble
          // pour mettre à jour les cartes de statistiques
        }

        // Fonction pour afficher les notifications toast
        function showToast(title, message, type = 'success', duration = 5000) {
          const container = document.getElementById('toast-container');
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          
          // Icône selon le type
          let icon = '';
          switch(type) {
            case 'success':
              icon = '<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
              break;
            case 'warning':
              icon = '<svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>';
              break;
            case 'error':
              icon = '<svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
              break;
            case 'info':
              icon = '<svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
              break;
            case 'achievement':
              icon = '<svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg>';
              break;
          }
          
          toast.innerHTML = `
            <div class="toast-header">
              <div class="flex items-center gap-2">
                ${icon}
                <div class="toast-title">${title}</div>
              </div>
              <button class="toast-close" onclick="this.parentElement.parentElement.remove()">×</button>
            </div>
            <div class="toast-message">${message}</div>
          `;
          
          container.appendChild(toast);
          
          setTimeout(() => {
            toast.classList.add('show');
          }, 100);
          
          if (duration > 0) {
            setTimeout(() => {
              toast.classList.remove('show');
              setTimeout(() => {
                if (toast.parentElement) {
                  toast.remove();
                }
              }, 300);
            }, duration);
          }
        }

        // Fonction pour vérifier et afficher les alertes d'objectifs
        function checkAndShowAchievementAlerts(data) {
          // Alerte pour objectif global atteint
          if (data.objectif_global_atteint && !localStorage.getItem('objectif_global_alert_shown')) {
            showToast(
              '🎯 Objectif atteint !', 
              `Félicitations ! L'objectif de la campagne a été atteint avec ${data.cotisation_active?.taux_realisation?.toFixed(2)}% de réalisation.`,
              'achievement',
              8000
            );
            localStorage.setItem('objectif_global_alert_shown', 'true');
          }
          
          // Alerte pour objectif personnel dépassé
          if (data.objectif_depasse_par_membre && !localStorage.getItem('objectif_personnel_alert_shown')) {
            showToast(
              '🏆 Objectif personnel dépassé !', 
              `Incroyable ! Vous avez dépassé votre objectif personnel avec ${data.taux_participation_reel?.toFixed(2)}% de participation.`,
              'achievement',
              8000
            );
            localStorage.setItem('objectif_personnel_alert_shown', 'true');
          }
          
          // Alerte pour première contribution
          if (data.a_contribue && !localStorage.getItem('premiere_contribution_alert_shown')) {
            showToast(
              '🌟 Première contribution !', 
              'Merci pour votre première contribution ! Vous faites maintenant partie de notre communauté solidaire.',
              'success',
              6000
            );
            localStorage.setItem('premiere_contribution_alert_shown', 'true');
          }
          
          // Alerte pour progression significative (50%, 75%, 90%)
          if (data.progression >= 50 && !localStorage.getItem('progression_50_alert_shown')) {
            showToast(
              '📈 Progression 50% !', 
              'Excellent ! La campagne a atteint 50% de son objectif. Continuez dans cette dynamique !',
              'info',
              6000
            );
            localStorage.setItem('progression_50_alert_shown', 'true');
          }
          
          if (data.progression >= 75 && !localStorage.getItem('progression_75_alert_shown')) {
            showToast(
              '🚀 Progression 75% !', 
              'Fantastique ! La campagne a atteint 75% de son objectif. Nous sommes presque arrivés !',
              'info',
              6000
            );
            localStorage.setItem('progression_75_alert_shown', 'true');
          }
          
          if (data.progression >= 90 && !localStorage.getItem('progression_90_alert_shown')) {
            showToast(
              '🎉 Progression 90% !', 
              'Incroyable ! La campagne a atteint 90% de son objectif. Plus que quelques pas vers la victoire !',
              'achievement',
              6000
            );
            localStorage.setItem('progression_90_alert_shown', 'true');
          }
        }

        // Fonction pour afficher une alerte de campagne urgente
        function showUrgentCampaignAlert() {
          const alertDiv = document.createElement('div');
          alertDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-gradient-to-r from-red-500 to-pink-500 text-white px-6 py-4 rounded-lg shadow-lg border-l-4 border-red-600';
          alertDiv.innerHTML = `
            <div class="flex items-center gap-3">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
              </svg>
              <div>
                <h4 class="font-semibold">🚨 Campagne urgente</h4>
                <p class="text-sm">La campagne se termine bientôt ! Contribuez maintenant pour atteindre l'objectif.</p>
              </div>
              <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          `;
          
          document.body.appendChild(alertDiv);
          
          // Auto-suppression après 10 secondes
          setTimeout(() => {
            if (alertDiv.parentElement) {
              alertDiv.remove();
            }
          }, 10000);
        }

        // Charger la page vue d'ensemble par défaut
        loadPage('overview');
        
        // Initialiser les couleurs des barres de progression au chargement
        setTimeout(updateProgressBarColors, 500);

        // Gestion du thème
        function initTheme() {
          const theme = localStorage.getItem('theme') || 'light';
          const themeToggle = document.getElementById('theme-toggle');
          const themeIconLight = document.getElementById('theme-icon-light');
          const themeIconDark = document.getElementById('theme-icon-dark');
          
          function setTheme(theme) {
            if (theme === 'dark') {
              document.documentElement.classList.add('dark');
              themeIconLight.classList.remove('hidden');
              themeIconDark.classList.add('hidden');
            } else {
              document.documentElement.classList.remove('dark');
              themeIconLight.classList.add('hidden');
              themeIconDark.classList.remove('hidden');
            }
            localStorage.setItem('theme', theme);
          }
          
          // Initialiser le thème
          setTheme(theme);
          
          // Gestionnaire d'événement pour le bouton de thème
          themeToggle.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
            
            // Afficher une notification
            showToast(
              newTheme === 'dark' ? '🌙 Mode sombre activé' : '☀️ Mode clair activé',
              `Le thème a été basculé vers le mode ${newTheme === 'dark' ? 'sombre' : 'clair'}.`,
              'info',
              3000
            );
          });
        }
        
        // Initialiser le thème
        initTheme();
        
        // Gestion du bouton d'actualisation
        function initRefreshButton() {
          document.addEventListener('click', function(e) {
            if (e.target.id === 'btn-refresh-stats' || e.target.closest('#btn-refresh-stats')) {
              e.preventDefault();
              
              // Ajouter une classe de rotation à l'icône
              const icon = e.target.querySelector('svg') || e.target.closest('#btn-refresh-stats').querySelector('svg');
              if (icon) {
                icon.classList.add('animate-spin');
              }
              
              // Actualiser les données
              Promise.all([
                updateStats(true), // Skip toasts pour éviter les doublons
                loadChartsData()
              ]).then(() => {
                // Arrêter la rotation après 1 seconde
                setTimeout(() => {
                  if (icon) {
                    icon.classList.remove('animate-spin');
                  }
                }, 1000);
                
                // Afficher une notification de succès
                showToast(
                  '✅ Données actualisées',
                  'Les statistiques ont été mises à jour avec succès.',
                  'success',
                  3000
                );
              }).catch((error) => {
                console.error('Erreur lors de l\'actualisation:', error);
                
                // Arrêter la rotation
                if (icon) {
                  icon.classList.remove('animate-spin');
                }
                
                // Afficher une notification d'erreur
                showToast(
                  '❌ Erreur d\'actualisation',
                  'Impossible de mettre à jour les données. Veuillez réessayer.',
                  'error',
                  5000
                );
              });
            }
          });
        }
        
        // Initialiser le bouton d'actualisation
        initRefreshButton();

        // Gestion du bouton "Valider tous les paiements"
        document.addEventListener('click', function (e) {
          if (e.target.id === 'valider-tous-paiements-btn' || e.target.closest('#valider-tous-paiements-btn')) {
            e.preventDefault();
            if (!confirm("Confirmer la validation de tous les paiements ?")) return;

            const button = e.target.closest('#valider-tous-paiements-btn') || e.target;
            const originalText = button.innerHTML;

            // Désactiver le bouton et montrer un indicateur de chargement
            button.disabled = true;
            button.innerHTML = `
              <svg class="animate-spin w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Validation en cours...
            `;

            fetch("{% url 'valider_tous_les_paiements' %}", {
              method: 'POST',
              headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
              }
            })
            .then(response => {
              if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              if (data.message) {
                showToast('✅ Succès', data.message, 'success');
                // Recharger la page de validation
                setTimeout(() => loadPage('validation'), 1000);
              }
            })
            .catch(err => {
              console.error(err);
              showToast('❌ Erreur', 'Une erreur est survenue lors de la validation en masse', 'error');
              
              // Réactiver le bouton
              button.disabled = false;
              button.innerHTML = originalText;
            });
          }
        });

        // Gestion des formulaires de validation individuels
        document.addEventListener('submit', function (e) {
          if (e.target.matches('.form-validation')) {
            e.preventDefault();

            const form = e.target;
            const url = form.action;
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;

            // Désactiver le bouton et montrer un indicateur de chargement
            submitButton.disabled = true;
            submitButton.innerHTML = `
              <svg class="animate-spin w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Validation...
            `;

            fetch(url, {
              method: 'POST',
              headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: new FormData(form)
            })
            .then(response => {
              if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              // Succès
              const container = form.closest('.paiement-item-valider');
              if (container) {
                container.innerHTML = `
                  <div class="p-6 text-center">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                      <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                      </svg>
                    </div>
                    <p class="text-green-600 font-semibold">✅ Paiement validé avec succès</p>
                  </div>
                `;
              }
              
              // Afficher une notification de succès
              showToast('✅ Succès', 'Paiement validé avec succès', 'success');
              
              // Déclencher la mise à jour des statistiques
              document.dispatchEvent(new CustomEvent('paiementValide'));
            })
            .catch(err => {
              console.error('Erreur lors de la validation:', err);
              
              // Réactiver le bouton
              submitButton.disabled = false;
              submitButton.innerHTML = originalText;
              
              // Afficher une notification d'erreur
              showToast('❌ Erreur', 'Erreur lors de la validation. Veuillez réessayer.', 'error');
            });
          }
        });

        // Fonction pour récupérer le cookie CSRF
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }
        
        // Fonction pour obtenir le token CSRF depuis le DOM
        function getCSRFToken() {
          // Essayer d'abord de récupérer depuis les cookies
          let token = getCookie('csrftoken');
          
          // Si pas trouvé dans les cookies, chercher dans le DOM
          if (!token) {
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (csrfInput) {
              token = csrfInput.value;
            }
          }
          
          // Si toujours pas trouvé, chercher dans les meta tags
          if (!token) {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag) {
              token = metaTag.getAttribute('content');
            }
          }
          
          return token;
        }

        // Fonction pour initialiser les filtres
        function initializeFilters() {
          console.log('Initialisation des filtres...');
          
          // Attendre un peu que le DOM soit mis à jour
          setTimeout(() => {
            // Initialiser les filtres pour l'historique des paiements
            if (document.getElementById('search-paiements')) {
              console.log('Initialisation des filtres historique...');
              initHistoriqueFilters();
            } else {
              console.log('Élément search-paiements non trouvé');
            }
            
            // Initialiser les filtres pour les paiements à valider
            if (document.getElementById('search-paiements-valider')) {
              console.log('Initialisation des filtres validation...');
              initValidationFilters();
            } else {
              console.log('Élément search-paiements-valider non trouvé');
            }
          }, 200); // Augmenté le délai pour s'assurer que le DOM est bien chargé
        }

        // Fonction pour initialiser les filtres de l'historique
        function initHistoriqueFilters() {
          console.log('Initialisation des filtres historique...');
          
          const searchInput = document.getElementById('search-paiements');
          const filterPeriode = document.getElementById('filter-periode');
          const sortPaiements = document.getElementById('sort-paiements');
          const resetFilters = document.getElementById('reset-filters');
          const searchResults = document.getElementById('search-results');
          const resultsCount = document.getElementById('results-count');
          const searchLoading = document.getElementById('search-loading');
          const paiementsContainer = document.getElementById('paiements-container');
          const paiementItems = document.querySelectorAll('.paiement-item');
          
          console.log('Éléments trouvés:', {
            searchInput: !!searchInput,
            filterPeriode: !!filterPeriode,
            sortPaiements: !!sortPaiements,
            resetFilters: !!resetFilters,
            paiementItems: paiementItems.length
          });
          
          if (!searchInput || !filterPeriode || !sortPaiements || !resetFilters) {
            console.log('Éléments de filtrage historique non trouvés');
            return;
          }
          
          let allPaiements = Array.from(paiementItems);
          let filteredPaiements = [...allPaiements];
          let filterTimeout;
          
          console.log('Filtres historique initialisés avec', allPaiements.length, 'paiements');
          
          // Afficher les données des premiers paiements pour debug
          if (allPaiements.length > 0) {
            console.log('Exemple de données du premier paiement:', {
              montant: allPaiements[0].dataset.montant,
              cotisation: allPaiements[0].dataset.cotisation,
              moyen: allPaiements[0].dataset.moyen,
              date: allPaiements[0].dataset.date
            });
          }
          
          // Fonction de filtrage avec debounce pour la recherche
          function filterPaiements(immediate = false) {
            if (!immediate) {
              clearTimeout(filterTimeout);
              filterTimeout = setTimeout(() => filterPaiements(true), 300);
              return;
            }
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            const periodeFilter = filterPeriode.value;
            const sortBy = sortPaiements.value;
            
            console.log('Filtrage avec:', {
              searchTerm,
              periodeFilter,
              sortBy,
              searchInputValue: searchInput.value,
              filterPeriodeValue: filterPeriode.value,
              sortPaiementsValue: sortPaiements.value
            });
            
            // Afficher l'indicateur de chargement
            if (searchLoading) {
              searchLoading.classList.remove('hidden');
            }
            
            // Simuler un délai pour l'effet visuel
            setTimeout(() => {
              console.log('Filtrage historique avec:', { searchTerm, periodeFilter, sortBy });
              
              // Filtrer par recherche
              filteredPaiements = allPaiements.filter(item => {
                const montant = item.dataset.montant;
                const cotisation = item.dataset.cotisation;
                const moyen = item.dataset.moyen;
                
                const matchesSearch = !searchTerm || 
                  montant.includes(searchTerm) || 
                  cotisation.includes(searchTerm) || 
                  moyen.includes(searchTerm);
                
                // Filtrer par période
                let matchesPeriode = true;
                if (periodeFilter) {
                  const itemDate = new Date(item.dataset.date);
                  const now = new Date();
                  const daysDiff = Math.floor((now - itemDate) / (1000 * 60 * 60 * 24));
                  matchesPeriode = daysDiff <= parseInt(periodeFilter);
                  console.log('Filtre période:', {
                    itemDate: item.dataset.date,
                    daysDiff,
                    periodeFilter,
                    matchesPeriode
                  });
                }
                
                return matchesSearch && matchesPeriode;
              });
              
              console.log('Après filtrage:', filteredPaiements.length, 'paiements');
              
              // Trier les résultats
              if (sortBy) {
                console.log('Tri avec:', sortBy);
                filteredPaiements.sort((a, b) => {
                  if (sortBy === 'montant') {
                    const aMontant = parseFloat(a.dataset.montant);
                    const bMontant = parseFloat(b.dataset.montant);
                    console.log('Tri montant croissant:', aMontant, bMontant);
                    return aMontant - bMontant; // Croissant
                  } else if (sortBy === '-montant') {
                    const aMontant = parseFloat(a.dataset.montant);
                    const bMontant = parseFloat(b.dataset.montant);
                    console.log('Tri montant décroissant:', aMontant, bMontant);
                    return bMontant - aMontant; // Décroissant
                  } else if (sortBy === 'date_paiement') {
                    const aDate = new Date(a.dataset.date);
                    const bDate = new Date(b.dataset.date);
                    console.log('Tri date ancien:', aDate, bDate);
                    return aDate - bDate; // Plus ancien en premier
                  } else if (sortBy === '-date_paiement') {
                    const aDate = new Date(a.dataset.date);
                    const bDate = new Date(b.dataset.date);
                    console.log('Tri date récent:', aDate, bDate);
                    return bDate - aDate; // Plus récent en premier
                  } else if (sortBy === 'membre__nom') {
                    const aMembre = a.dataset.membre;
                    const bMembre = b.dataset.membre;
                    return aMembre.localeCompare(bMembre); // A-Z
                  } else if (sortBy === '-membre__nom') {
                    const aMembre = a.dataset.membre;
                    const bMembre = b.dataset.membre;
                    return bMembre.localeCompare(aMembre); // Z-A
                  }
                  return 0;
                });
              }
              
              console.log('Résultats filtrés historique:', filteredPaiements.length);
              
              // Afficher les résultats
              displayResults();
              
              // Masquer l'indicateur de chargement
              if (searchLoading) {
                searchLoading.classList.add('hidden');
              }
            }, 150);
          }
          
          // Fonction d'affichage des résultats avec animation
          function displayResults() {
            console.log('Affichage des résultats:', filteredPaiements.length, 'paiements');
            
            // Masquer tous les éléments avec animation
            allPaiements.forEach((item, index) => {
              item.style.opacity = '0';
              item.style.transform = 'translateY(10px)';
              item.style.transition = 'all 0.3s ease';
              
              setTimeout(() => {
                item.style.display = 'none';
              }, 300);
            });
            
            // Afficher les éléments filtrés avec animation
            setTimeout(() => {
              // Réorganiser les éléments dans le DOM selon l'ordre trié
              const container = paiementsContainer.querySelector('.divide-y');
              if (container) {
                // Supprimer tous les éléments existants
                container.innerHTML = '';
                
                // Ajouter les éléments dans l'ordre trié
                filteredPaiements.forEach((item, index) => {
                  // Cloner l'élément pour éviter les problèmes de référence
                  const clonedItem = item.cloneNode(true);
                  clonedItem.style.display = 'block';
                  clonedItem.style.opacity = '0';
                  clonedItem.style.transform = 'translateY(10px)';
                  clonedItem.style.transition = 'all 0.3s ease';
                  
                  container.appendChild(clonedItem);
                  
                  // Animation d'apparition
                  setTimeout(() => {
                    clonedItem.style.opacity = '1';
                    clonedItem.style.transform = 'translateY(0)';
                  }, index * 50);
                });
              }
              
              // Mettre à jour le compteur
              if (resultsCount) {
                resultsCount.textContent = filteredPaiements.length;
              }
              
              // Afficher/masquer la section résultats
              if (searchResults) {
                if (searchInput.value || filterPeriode.value) {
                  searchResults.classList.remove('hidden');
                } else {
                  searchResults.classList.add('hidden');
                }
              }
              
              // Afficher un message si aucun résultat
              showNoResultsMessage();
            }, 350);
          }
          
          // Fonction pour afficher le message "aucun résultat"
          function showNoResultsMessage() {
            const existingNoResults = paiementsContainer.querySelector('.no-results-message');
            if (existingNoResults) {
              existingNoResults.remove();
            }
            
            if (filteredPaiements.length === 0 && (searchInput.value || filterPeriode.value)) {
              const noResultsDiv = document.createElement('div');
              noResultsDiv.className = 'no-results-message p-12 text-center';
              noResultsDiv.innerHTML = `
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Aucun résultat trouvé</h3>
                <p class="mt-1 text-sm text-gray-500">Essayez de modifier vos critères de recherche.</p>
                <button onclick="resetAllFiltersHistorique()" class="mt-4 inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  Réinitialiser les filtres
                </button>
              `;
              
              paiementsContainer.appendChild(noResultsDiv);
            }
          }
          
          // Fonction de réinitialisation globale
          window.resetAllFiltersHistorique = function() {
            searchInput.value = '';
            filterPeriode.value = '';
            sortPaiements.value = '-date_paiement';
            filteredPaiements = [...allPaiements];
            displayResults();
          };
          
          // Événements avec feedback visuel
          searchInput.addEventListener('input', () => {
            filterPaiements(false); // Avec debounce
          });
          
          filterPeriode.addEventListener('change', () => {
            filterPaiements(true); // Immédiat
          });
          
          sortPaiements.addEventListener('change', () => {
            filterPaiements(true); // Immédiat
          });
          
          resetFilters.addEventListener('click', resetAllFiltersHistorique);
          
          // Initialisation
          filterPaiements(true);
        }

        // Fonction pour initialiser les filtres de validation
        function initValidationFilters() {
          console.log('Initialisation des filtres validation...');
          
          const searchInput = document.getElementById('search-paiements-valider');
          const filterPeriode = document.getElementById('filter-periode-valider');
          const sortPaiements = document.getElementById('sort-paiements-valider');
          const resetFilters = document.getElementById('reset-filters-valider');
          const searchResults = document.getElementById('search-results-valider');
          const resultsCount = document.getElementById('results-count-valider');
          const searchLoading = document.getElementById('search-loading-valider');
          const paiementsContainer = document.getElementById('paiements-container-valider');
          const paiementItems = document.querySelectorAll('.paiement-item-valider');
          
          if (!searchInput || !filterPeriode || !sortPaiements || !resetFilters) {
            console.log('Éléments de filtrage validation non trouvés');
            return;
          }
          
          let allPaiements = Array.from(paiementItems);
          let filteredPaiements = [...allPaiements];
          let filterTimeout;
          
          console.log('Filtres validation initialisés avec', allPaiements.length, 'paiements');
          
          // Fonction de filtrage avec debounce pour la recherche
          function filterPaiements(immediate = false) {
            if (!immediate) {
              clearTimeout(filterTimeout);
              filterTimeout = setTimeout(() => filterPaiements(true), 300);
              return;
            }
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            const periodeFilter = filterPeriode.value;
            const sortBy = sortPaiements.value;
            
            // Afficher l'indicateur de chargement
            if (searchLoading) {
              searchLoading.classList.remove('hidden');
            }
            
            // Simuler un délai pour l'effet visuel
            setTimeout(() => {
              console.log('Filtrage validation avec:', { searchTerm, periodeFilter, sortBy });
              
              // Filtrer par recherche
              filteredPaiements = allPaiements.filter(item => {
                const montant = item.dataset.montant;
                const cotisation = item.dataset.cotisation;
                const membre = item.dataset.membre;
                
                const matchesSearch = !searchTerm || 
                  montant.includes(searchTerm) || 
                  cotisation.includes(searchTerm) || 
                  membre.includes(searchTerm);
                
                // Filtrer par période
                let matchesPeriode = true;
                if (periodeFilter) {
                  const itemDate = new Date(item.dataset.date);
                  const now = new Date();
                  const daysDiff = Math.floor((now - itemDate) / (1000 * 60 * 60 * 24));
                  matchesPeriode = daysDiff <= parseInt(periodeFilter);
                }
                
                return matchesSearch && matchesPeriode;
              });
              
              // Trier les résultats
              if (sortBy) {
                console.log('Tri avec:', sortBy);
                filteredPaiements.sort((a, b) => {
                  if (sortBy === 'montant') {
                    const aMontant = parseFloat(a.dataset.montant);
                    const bMontant = parseFloat(b.dataset.montant);
                    return aMontant - bMontant; // Croissant
                  } else if (sortBy === '-montant') {
                    const aMontant = parseFloat(a.dataset.montant);
                    const bMontant = parseFloat(b.dataset.montant);
                    return bMontant - aMontant; // Décroissant
                  } else if (sortBy === 'date_paiement') {
                    const aDate = new Date(a.dataset.date);
                    const bDate = new Date(b.dataset.date);
                    return aDate - bDate; // Plus ancien en premier
                  } else if (sortBy === '-date_paiement') {
                    const aDate = new Date(a.dataset.date);
                    const bDate = new Date(b.dataset.date);
                    return bDate - aDate; // Plus récent en premier
                  } else if (sortBy === 'membre__nom') {
                    const aMembre = a.dataset.membre;
                    const bMembre = b.dataset.membre;
                    return aMembre.localeCompare(bMembre); // A-Z
                  } else if (sortBy === '-membre__nom') {
                    const aMembre = a.dataset.membre;
                    const bMembre = b.dataset.membre;
                    return bMembre.localeCompare(aMembre); // Z-A
                  }
                  return 0;
                });
              }
              
              console.log('Résultats filtrés validation:', filteredPaiements.length);
              
              // Afficher les résultats
              displayResults();
              
              // Masquer l'indicateur de chargement
              if (searchLoading) {
                searchLoading.classList.add('hidden');
              }
            }, 150);
          }
          
          // Fonction d'affichage des résultats avec animation
          function displayResults() {
            console.log('Affichage des résultats validation:', filteredPaiements.length, 'paiements');
            
            // Masquer tous les éléments avec animation
            allPaiements.forEach((item, index) => {
              item.style.opacity = '0';
              item.style.transform = 'translateY(10px)';
              item.style.transition = 'all 0.3s ease';
              
              setTimeout(() => {
                item.style.display = 'none';
              }, 300);
            });
            
            // Afficher les éléments filtrés avec animation
            setTimeout(() => {
              // Réorganiser les éléments dans le DOM selon l'ordre trié
              const container = paiementsContainer.querySelector('.divide-y');
              if (container) {
                // Supprimer tous les éléments existants
                container.innerHTML = '';
                
                // Ajouter les éléments dans l'ordre trié
                filteredPaiements.forEach((item, index) => {
                  // Cloner l'élément pour éviter les problèmes de référence
                  const clonedItem = item.cloneNode(true);
                  clonedItem.style.display = 'block';
                  clonedItem.style.opacity = '0';
                  clonedItem.style.transform = 'translateY(10px)';
                  clonedItem.style.transition = 'all 0.3s ease';
                  
                  container.appendChild(clonedItem);
                  
                  // Animation d'apparition
                  setTimeout(() => {
                    clonedItem.style.opacity = '1';
                    clonedItem.style.transform = 'translateY(0)';
                  }, index * 50);
                });
              }
              
              // Mettre à jour le compteur
              if (resultsCount) {
                resultsCount.textContent = filteredPaiements.length;
              }
              
              // Afficher/masquer la section résultats
              if (searchResults) {
                if (searchInput.value || filterPeriode.value) {
                  searchResults.classList.remove('hidden');
                } else {
                  searchResults.classList.add('hidden');
                }
              }
              
              // Afficher un message si aucun résultat
              showNoResultsMessage();
            }, 350);
          }
          
          // Fonction pour afficher le message "aucun résultat"
          function showNoResultsMessage() {
            const existingNoResults = paiementsContainer.querySelector('.no-results-message');
            if (existingNoResults) {
              existingNoResults.remove();
            }
            
            if (filteredPaiements.length === 0 && (searchInput.value || filterPeriode.value)) {
              const noResultsDiv = document.createElement('div');
              noResultsDiv.className = 'no-results-message p-12 text-center';
              noResultsDiv.innerHTML = `
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Aucun paiement trouvé</h3>
                <p class="mt-1 text-sm text-gray-500">Aucun paiement ne correspond à vos critères de recherche.</p>
                <button onclick="resetAllFiltersValidation()" class="mt-4 inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  Réinitialiser les filtres
                </button>
              `;
              
              paiementsContainer.appendChild(noResultsDiv);
            }
          }
          
          // Fonction de réinitialisation globale
          window.resetAllFiltersValidation = function() {
            searchInput.value = '';
            filterPeriode.value = '';
            sortPaiements.value = '-date_paiement';
            filteredPaiements = [...allPaiements];
            displayResults();
          };
          
          // Événements avec feedback visuel
          searchInput.addEventListener('input', () => {
            filterPaiements(false); // Avec debounce
          });
          
          filterPeriode.addEventListener('change', () => {
            filterPaiements(true); // Immédiat
          });
          
          sortPaiements.addEventListener('change', () => {
            filterPaiements(true); // Immédiat
          });
          
          resetFilters.addEventListener('click', resetAllFiltersValidation);
          
          // Initialisation
          filterPaiements(true);
        }

        // Initialiser le bouton d'actualisation
        initRefreshButton();

        // Fonction pour mettre à jour les couleurs de la barre de progression
        function updateProgressBarColors() {
          const progressBars = document.querySelectorAll('.progress-bar-fill');
          
          progressBars.forEach(bar => {
            const progression = parseFloat(bar.dataset.progression);
            
            // Supprimer toutes les classes de progression existantes
            bar.classList.remove('progress-low', 'progress-medium', 'progress-high', 'progress-complete');
            
            // Ajouter la classe appropriée selon le pourcentage
            if (progression >= 100) {
              bar.classList.add('progress-complete');
            } else if (progression >= 75) {
              bar.classList.add('progress-high');
            } else if (progression >= 50) {
              bar.classList.add('progress-medium');
            } else {
              bar.classList.add('progress-low');
            }
          });
        }
      });
    </script>
  </body>
</html>
